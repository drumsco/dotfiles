#!/usr/bin/env bash
set -e

# http://tech.naviplus.co.jp/2014/01/09/tmux%E3%81%A7%E8%A4%87%E6%95%B0%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E5%90%8C%E6%99%82%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3/

usage_exit() {
    cat <<EOT
Usage:
    $0 -c command [arg ... | -f file ...]
EOT
    if [ -z "$1" ]; then
        exit 1
    else
        exit $1
    fi
}

split_window() {
    if [ $is_first -ne 1 ]; then
        tmux split-window -t ${session_name}:${window_name}
        tmux select-layout -t ${session_name}:${window_name} tiled
    fi
    escaped=$(echo $1 | sed -e 's,\\,\\\\\\\\,g' -e 's,/,\\/,g')
    tmux send-keys -t ${session_name}:${window_name} "$(echo $cmd | sed "s/{}/$escaped/")"
}

while getopts c:fh OPT
do
    case $OPT in
        c)  cmd=$OPTARG
            ;;
        f)  file_flag=1
            ;;
        h)  usage_exit 0
            ;;
        *)  usage_exit
            ;;
    esac
done

if [ -z "$cmd" ]; then
    usage_exit
fi

shift $((OPTIND - 1))

window_name=multi-ssh-`date +%s`
if [ -n "$TMUX" ];then
    # tmux内にいる時は新しいウィンドウを作る
    tmux new-window -n $window_name
    session_name=$(tmux display-message -p "#{session_name}")
else
    # 新しいセッションを作ってデタッチ
    session_name=multi-ssh-`date +%s`
    tmux new-session -d -n $window_name -s $session_name
fi

is_first=1
if [ "$file_flag" == "1" ]; then
    for file in $*; do
        if [ ! -f "$file" ]; then
            echo "no such file: $file"
            tmux kill-window -t ${session_name}:${window_name}
            exit 1
        fi
        while read line; do
            # #で始まる行はスキップ
            echo $line | grep -E '^\s*#' 1> /dev/null 2>&1 && continue
            split_window "$line"
            is_first=0
        done < $file
    done
else
    for i in $*; do
        split_window "$i"
        is_first=0
    done
fi

# paneの同期モードを設定
tmux set-window-option -t ${session_name}:${window_name} synchronize-panes on

# 分割したペインをセレクト
if [ -n "$TMUX" ]; then
    tmux select-pane -t ${session_name}:${window_name}
else
    tmux -2 attach-session -t ${session_name}:${window_name}
fi
